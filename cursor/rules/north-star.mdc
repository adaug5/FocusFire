---
alwaysApply: true
---
# FocusFire Project North Star: The Unified Collaborative History Engine

## Core Mission
Build a versatile, Notion-esque document database where "Everything is an Entity." The system must support real-time character-level collaboration while maintaining a permanent, branchable, and cryptographically verifiable history (Merkle-DAG), enabling a GitHub-style workflow for structured document data.

## Architectural Invariants (Non-Negotiable Rules)
- **Logical Nesting, Physical Flatness:** All content items (pages, tasks, text blocks) are rows in a flat entities table. Do NOT use physical deep-nesting (standard JSON). Use PostgreSQL ltree for hierarchical pathing and adjacency.
- **State vs. History:** The database is append-only. The "Current State" is a view generated by the latest Commit in a Merkle-DAG. Every change is an immutable delta.
- **Real-time via CRDT (Loro):** Use the Loro library for deterministic convergence. Do not use "Last-Writer-Wins" or full-object overwrites for collaborative fields.
- **Relationship-Based Access Control (ReBAC):** Use Zanzibar-style Relationship Tuples (e.g., workspace#member@user). Authorization must be decoupled from the data fetch logic.
- **Workspace-First Sharding:** All data must be partitioned by workspace_id to ensure horizontal scalability and local transactionality.

## Technical Stack
- **Database:** PostgreSQL + ltree extension.
- **Sync Library:** Loro (CRDT with built-in DAG history).
- **Permissions:** Zanzibar-inspired logic (SpiceDB or Tuple implementation).
- **Local Storage:** IndexedDB (offline-first storage for CRDT deltas).

## Definition of Done (Success Criteria)
- **Versioning:** Users must be able to "checkout" any previous Commit Hash and render the visual state.
- **Branching:** Creating a branch must be a lightweight $O(1)$ operation.
- **Security:** ReBAC "Check" must return true before any read.